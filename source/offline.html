<!DOCTYPE html>

<html>
<head>
  <title>offline.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="offline.html">
                offline.coffee
              </a>
            
              
              <a class="source" href="reconnect.html">
                reconnect.coffee
              </a>
            
              
              <a class="source" href="requests.html">
                requests.coffee
              </a>
            
              
              <a class="source" href="snake.html">
                snake.coffee
              </a>
            
              
              <a class="source" href="ui.html">
                ui.coffee
              </a>
            
              
              <a class="source" href="_keyframes.html">
                _keyframes.sass
              </a>
            
              
              <a class="source" href="_mixins.html">
                _mixins.sass
              </a>
            
              
              <a class="source" href="_offline-theme-base-indicator.html">
                _offline-theme-base-indicator.sass
              </a>
            
              
              <a class="source" href="_offline-theme-base.html">
                _offline-theme-base.sass
              </a>
            
              
              <a class="source" href="offline-theme-chrome-indicator.html">
                offline-theme-chrome-indicator.sass
              </a>
            
              
              <a class="source" href="offline-theme-chrome.html">
                offline-theme-chrome.sass
              </a>
            
              
              <a class="source" href="offline-theme-dark-indicator.html">
                offline-theme-dark-indicator.sass
              </a>
            
              
              <a class="source" href="offline-theme-dark.html">
                offline-theme-dark.sass
              </a>
            
              
              <a class="source" href="offline-theme-default-indicator.html">
                offline-theme-default-indicator.sass
              </a>
            
              
              <a class="source" href="offline-theme-default.html">
                offline-theme-default.sass
              </a>
            
              
              <a class="source" href="offline-theme-hubspot.html">
                offline-theme-hubspot.sass
              </a>
            
              
              <a class="source" href="offline-theme-slide-indicator.html">
                offline-theme-slide-indicator.sass
              </a>
            
              
              <a class="source" href="offline-theme-slide.html">
                offline-theme-slide.sass
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>offline.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>We get a clue that the browser might be offline from suspicious requests or
the HTML5 offline api.  If we suspect it&#39;s offline, we make a request for any random path
which (probably) doesn&#39;t exist.  If we get a response, we&#39;re still online, if not,
we trigger an event and update our status.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">extendNative</span></span> = (to, from) -&gt;
  <span class="keyword">for</span> key <span class="keyword">of</span> from::
    <span class="keyword">try</span>
      val = from::[key]

      <span class="keyword">if</span> <span class="keyword">not</span> to[key]? <span class="keyword">and</span> <span class="keyword">typeof</span> val <span class="keyword">isnt</span> <span class="string">'function'</span>
        to[key] = val
    <span class="keyword">catch</span> e

Offline = {}

Offline.options ?= {}
defaultOptions =
  checks:
    xhr:
      url: -&gt;
        <span class="string">"/offline-test-request/<span class="subst">#{ Math.floor(Math.random() * <span class="number">1000000000</span>) }</span>"</span>

    image:
      url: -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This can be any image, feel free to use our ultra-small gif:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="string">"http://dqakt69vkj09v.cloudfront.net/are-we-online.gif?_=<span class="subst">#{ Math.floor(Math.random() * <span class="number">1000000000</span>) }</span>"</span>

    active: <span class="string">'image'</span>

  checkOnLoad: <span class="literal">false</span>

  interceptRequests: <span class="literal">true</span>

  reconnect: <span class="literal">true</span>

<span class="function"><span class="title">grab</span></span> = (obj, key) -&gt;
  cur = obj
  parts = key.split(<span class="string">'.'</span>)
  <span class="keyword">for</span> part, i <span class="keyword">in</span> parts
    cur = cur[part]
    <span class="keyword">break</span> <span class="keyword">if</span> <span class="keyword">typeof</span> cur <span class="keyword">isnt</span> <span class="string">'object'</span>

  <span class="keyword">if</span> i <span class="keyword">is</span> parts.length - <span class="number">1</span>
    cur
  <span class="keyword">else</span>
    <span class="literal">undefined</span>
  
Offline.<span class="function"><span class="title">getOption</span></span> = (key) -&gt;
  val = grab(Offline.options, key) ? grab(defaultOptions, key)

  <span class="keyword">if</span> <span class="keyword">typeof</span> val <span class="keyword">is</span> <span class="string">'function'</span>
    val()
  <span class="keyword">else</span>
    val</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>These events are available in modern browsers, but they mean different things.
In FF and IE they mean the user has explicitly entered &quot;Offline Mode&quot;
In Chrome they mean that the internet connection was lost or restored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>window.addEventListener? <span class="string">'online'</span>, -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The event fires slightly before the browser is ready to make a request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setTimeout Offline.confirmUp, <span class="number">100</span>
, <span class="literal">false</span>

window.addEventListener? <span class="string">'offline'</span>, -&gt;
  Offline.confirmDown()
, <span class="literal">false</span>

Offline.state = <span class="string">'up'</span>

Offline.<span class="function"><span class="title">markUp</span></span> = -&gt;
  Offline.trigger <span class="string">'confirmed-up'</span>

  <span class="keyword">return</span> <span class="keyword">if</span> Offline.state <span class="keyword">is</span> <span class="string">'up'</span>

  Offline.state = <span class="string">'up'</span>
  Offline.trigger <span class="string">'up'</span>

Offline.<span class="function"><span class="title">markDown</span></span> = -&gt;
  Offline.trigger <span class="string">'confirmed-down'</span>

  <span class="keyword">return</span> <span class="keyword">if</span> Offline.state <span class="keyword">is</span> <span class="string">'down'</span>

  Offline.state = <span class="string">'down'</span>
  Offline.trigger <span class="string">'down'</span>

handlers = {}

Offline.<span class="function"><span class="title">on</span></span> = (event, handler, ctx) -&gt;
  events = event.split(<span class="string">' '</span>)

  <span class="keyword">if</span> events.length &gt; <span class="number">1</span>
    Offline.<span class="literal">on</span>(e, handler, ctx) <span class="keyword">for</span> e <span class="keyword">in</span> events
  <span class="keyword">else</span>
    handlers[event] ?= []
    handlers[event].push [ctx, handler]

Offline.<span class="function"><span class="title">off</span></span> = (event, handler) -&gt;
  <span class="keyword">return</span> <span class="keyword">unless</span> handlers[event]?

  <span class="keyword">if</span> <span class="keyword">not</span> handler
    handlers[event] = []
  <span class="keyword">else</span>
    i = <span class="number">0</span>
    <span class="keyword">while</span> i &lt; handlers[event].length
      [ctx, _handler] = handlers[event][i]
      <span class="keyword">if</span> _handler <span class="keyword">is</span> handler
        handlers[event].splice i, <span class="number">1</span>
      <span class="keyword">else</span>
        i++

Offline.<span class="function"><span class="title">trigger</span></span> = (event) -&gt;
  <span class="keyword">if</span> handlers[event]?
    <span class="keyword">for</span> [ctx, handler] <span class="keyword">in</span> handlers[event]
      handler.call(ctx)

<span class="function"><span class="title">checkXHR</span></span> = (xhr, onUp, onDown) -&gt;
  <span class="function"><span class="title">checkStatus</span></span> = -&gt;
    <span class="keyword">if</span> xhr.status <span class="keyword">and</span> xhr.status &lt; <span class="number">12000</span>
      onUp()
    <span class="keyword">else</span>
      onDown()

  <span class="keyword">if</span> xhr.onprogress <span class="keyword">is</span> <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>onprogress would be undefined on older browsers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    xhr.addEventListener <span class="string">'error'</span>, onDown, <span class="literal">false</span>
    xhr.addEventListener <span class="string">'timeout'</span>, onDown, <span class="literal">false</span>
    xhr.addEventListener <span class="string">'load'</span>, checkStatus, <span class="literal">false</span>
  <span class="keyword">else</span>
    _onreadystatechange = xhr.onreadystatechange
    xhr.<span class="function"><span class="title">onreadystatechange</span></span> = -&gt;
      <span class="keyword">if</span> xhr.readyState <span class="keyword">is</span> <span class="number">4</span>
        checkStatus()
      <span class="keyword">else</span> <span class="keyword">if</span> xhr.readyState <span class="keyword">is</span> <span class="number">0</span>
        onDown()

      _onreadystatechange?(arguments...)

Offline.checks = {}
Offline.checks.<span class="function"><span class="title">xhr</span></span> = -&gt;
  xhr = <span class="keyword">new</span> XMLHttpRequest

  xhr.offline = <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>It doesn&#39;t matter what this hits, even a 404 is considered up.  It is important however that
it&#39;s on the same domain and port, so CORS issues don&#39;t come into play.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  xhr.open(<span class="string">'HEAD'</span>, Offline.getOption(<span class="string">'checks.xhr.url'</span>), <span class="literal">true</span>)

  checkXHR xhr, Offline.markUp, Offline.markDown

  <span class="keyword">try</span>
    xhr.send()
  <span class="keyword">catch</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Catch NETWORK_ERRORS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Offline.markDown()

  xhr

Offline.checks.<span class="function"><span class="title">image</span></span> = -&gt;
  img = document.createElement <span class="string">'img'</span>
  img.onerror = Offline.markDown
  img.onload = Offline.markUp
  img.src = Offline.getOption(<span class="string">'checks.image.url'</span>)
  
  <span class="literal">undefined</span>

Offline.<span class="function"><span class="title">check</span></span> = -&gt;
  Offline.trigger <span class="string">'checking'</span>

  Offline.checks[Offline.getOption(<span class="string">'checks.active'</span>)]()

Offline.confirmUp = Offline.confirmDown = Offline.check

Offline.<span class="function"><span class="title">onXHR</span></span> = (cb) -&gt;
  <span class="function"><span class="title">monitorXHR</span></span> = (req, flags) -&gt;
    _open = req.open
    req.<span class="function"><span class="title">open</span></span> = (type, url, async, user, password) -&gt;
      cb {type, url, async, flags, user, password, xhr: req}

      _open.apply req, arguments

  _XMLHttpRequest = window.XMLHttpRequest
  window.<span class="function"><span class="title">XMLHttpRequest</span></span> = (flags) -&gt;
    req = <span class="keyword">new</span> _XMLHttpRequest(flags)

    monitorXHR req, flags

    _setRequestHeader = req.setRequestHeader
    req.headers = {}
    req.<span class="function"><span class="title">setRequestHeader</span></span> = (name, value) -&gt;
      req.headers[name] = value

      _setRequestHeader.call req, name, value

    _overrideMimeType = req.overrideMimeType
    req.<span class="function"><span class="title">overrideMimeType</span></span> = (type) -&gt;
      req.mimeType = type

      _overrideMimeType.call req, type

    req

  extendNative window.XMLHttpRequest, _XMLHttpRequest

  <span class="keyword">if</span> window.XDomainRequest?
    _XDomainRequest = window.XDomainRequest
    window.<span class="function"><span class="title">XDomainRequest</span></span> = -&gt;
      req = <span class="keyword">new</span> _XDomainRequest

      monitorXHR req

      req

    extendNative window.XDomainRequest, _XDomainRequest

<span class="function"><span class="title">init</span></span> = -&gt;
  <span class="keyword">if</span> Offline.getOption <span class="string">'interceptRequests'</span>
    Offline.onXHR ({xhr}) -&gt;
      <span class="keyword">unless</span> xhr.offline <span class="keyword">is</span> <span class="literal">false</span>
        checkXHR xhr, Offline.confirmUp, Offline.confirmDown

  <span class="keyword">if</span> Offline.getOption <span class="string">'checkOnLoad'</span>
    Offline.check()</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>We call init in a setTimeout to give time for options to be set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>setTimeout init, <span class="number">0</span>

window.Offline = Offline</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
